<html>
<head>
<script src="a.out.js"></script>
<script src="dat.gui.min.js"></script>
<script src="plotly.min.js"></script>
<script src="Debugging.js"></script>
</head>
<body>
    <table>
        <tr>
        <td><input type="text" id="numPerms" size="3"></input></td>
        <td>
        <button type="button" onclick="findGreedyPerm()" id="greedyPerm">Get Greedy Perm</button>
        </td>
        </tr>
    </table>

    <table>
        <tr>
            <td>
                <canvas id="segcanvas" width="600" height="600" style="border:1px solid #000000;">
                </canvas>
            </td>
            <td>
                <p id = "persistenceDiagrams"></p>
            </td>
        </tr>
    </table>


    <script type="text/javascript">
        let isCompiled = false;
        let points = []; // These are our points in Javascript
        let idxPerm = [];
        let distLandLand = null;
        let distLandData = null;
        let dgms = null; // Persistence diagrams
        let cocycles = null; // Representative cocycles
        let X = null; // These are our points in C++
        let distLandLandCheck = null;
        let distLandDataCheck = null;
        let numPermsInput = document.getElementById("numPerms");
        let canvas = document.getElementById("segcanvas");
        let ctx = canvas.getContext("2d");

        Module.onRuntimeInitialized = function () {
            isCompiled = true;
            distLandLand = new Module.VectorFloat();
            distLandData = new Module.VectorVectorFloat();
            X = new Module.VectorVectorFloat();
            distLandDataCheck = new Module.VectorVectorFloat();
            distLandLandCheck = new Module.VectorFloat();
            dgms = new Module.VectorVectorFloat();
            cocycles = new Module.VectorVectorVectorInt();
        }

        function repaint() {
            let dW = 5;
            let W = canvas.width;
            let H = canvas.height;
            ctx.clearRect(0, 0, W, H);
            ctx.fillStyle = "#000000";
            for (let i = 0; i < points.length; i++) {
                let x = points[i][0];
                let y = points[i][1];
                ctx.fillRect(x, y, dW, dW);
            }
            ctx.fillStyle = "#ff0000";
            dW = 10;
            for (let i = 0; i < idxPerm.length; i++) {
                let x = points[idxPerm[i]][0];
                let y = points[idxPerm[i]][1];
                ctx.fillRect(x, y, dW, dW);
            }
        }

        function getMousePosition(canvas, event) {
            let rect = canvas.getBoundingClientRect();
            let x = event.clientX - rect.left;
            let y = event.clientY - rect.top;
            points.push([x, y]);
            repaint();
        }

        let canvasElem = document.querySelector("canvas");

        canvasElem.addEventListener("mousedown", function (e) {
            getMousePosition(canvasElem, e);
        });

        function computeRips(distLandLand) {
            Module.clearVectorVector(dgms);
            Module.clearVectorVectorVectorInt(cocycles);
            // TODO: Send over infinity as threshold
            let field = 2;
            let homdim = 1;
            let thresh = 1e12;
            Module.jsRipsDM(distLandLand, field, homdim, thresh, 1, 
            dgms, cocycles);

            let H1 = dgms.get(1);
            let births = [];
            let deaths = [];
            for (let i = 0; i < H1.size(); i+=2) {
                births.push(H1.get(i));
                deaths.push(H1.get(i+1));
            }
            let dgmPoints = {x:births, y:deaths, mode:'markers', name:'H1'};
            let axMin = Math.min(Math.min.apply(null, births), Math.min.apply(null, deaths));
            let axMax = Math.max(Math.max.apply(null, births), Math.max.apply(null, deaths));
            let axRange = axMax - axMin;
            let diagonal = {x:[axMin-axRange/5, axMax+axRange/5], y:[axMin-axRange/5, axMax+axRange/5], mode:'scatter', name:'diagonal'};
            let layout = {title:'H1'};
            Plotly.newPlot('persistenceDiagrams', [dgmPoints, diagonal], layout);
        }

        function findGreedyPerm() {
            if (isCompiled) {
                Module.clearVector(distLandLand);
                Module.clearVectorVector(distLandData);
                Module.clearVectorVector(X);
                for (let i = 0; i < points.length; i++) {
                    let x = new Module.VectorFloat();
                    for (let j = 0; j < points[i].length; j++) {
                        x.push_back(points[i][j]);
                    }
                    X.push_back(x);
                }
                let k = parseInt(numPermsInput.value);
                k = Math.min(k, points.length);
                console.log(k);
                let perm = new Module.getGreedyPerm(X, k, distLandLand, distLandData);
                idxPerm.length = 0;
                for (let i = 0; i < k; i++) {
                    idxPerm.push(perm.get(i));
                }
                computeRips(distLandLand);
                repaint();
            }
            else {
                alert("Not Compiled Yet");
            }
        }


    </script>

</body>
</html>